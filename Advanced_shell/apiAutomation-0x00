#!/bin/bash

API_URL="https://pokeapi.co/api/v2/pokemon/pikachu"
OUT_FILE="data.json"
ERR_FILE="errors.txt"

tmp_body=$(mktemp) || exit 1
tmp_err=$(mktemp)  || { rm -f "$tmp_body"; exit 1; }

cleanup() {
	rm -f "$tmp_body" "$tmp_err"
}
trap cleanup EXIT

# Perform request: body -> tmp_body, stderr -> tmp_err, and capture HTTP code
http_code=$(curl -sS -w "%{http_code}" -o "$tmp_body" "$API_URL" 2> "$tmp_err")
curl_exit=$?

timestamp() { date -u +"%Y-%m-%dT%H:%M:%SZ"; }

if [ $curl_exit -ne 0 ]; then
	printf '%s [curl_error] URL=%s exit=%d\n%s\n\n' "$(timestamp)" "$API_URL" "$curl_exit" "$(cat "$tmp_err")" >> "$ERR_FILE"
	exit 1
fi

if [ "$http_code" != "200" ]; then
	printf '%s [http_error] URL=%s status=%s\nResponse:\n' "$(timestamp)" "$API_URL" "$http_code" >> "$ERR_FILE"
	cat "$tmp_body" >> "$ERR_FILE"
	printf '\n\n' >> "$ERR_FILE"
	exit 1
fi

# Success: move temp body to output file
mv "$tmp_body" "$OUT_FILE"
# remove tmp_err (cleanup via trap)
exit 0
